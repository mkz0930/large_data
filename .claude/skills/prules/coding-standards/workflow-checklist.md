# 工作流程检查清单

在执行任何编码任务时，必须按照以下清单进行。

## 🎯 工作模式

### 交互模式（默认）
每个阶段完成后需要用户确认才能继续。

### 自动模式
用户在请求中包含 `auto`/`自动`/`no confirm` 等关键词，或配置 `.claude/prules.local.md`。

---

## ✅ 阶段 1：需求理解和头脑风暴 ✋

- [ ] 理解用户需求
- [ ] 进行头脑风暴，设计技术方案
- [ ] 将任务拆分成细粒度的子任务
- [ ] 使用 TodoWrite 创建详细的任务清单

### 📋 阶段 1 输出
- 需求分析总结
- 技术方案说明（技术栈、架构设计）
- 详细的任务清单
- 预期的实现步骤

### ✋ 确认点
**交互模式**：向用户展示方案，等待确认后继续
**自动模式**：展示方案后自动继续

---

## ✅ 阶段 2：测试驱动开发（TDD） ✋

- [ ] 先编写测试用例（在实现代码之前）
- [ ] 测试覆盖：正常情况、边界情况、异常情况
- [ ] 运行测试，确保测试失败（红灯）

### 📋 阶段 2 输出
- 创建的测试文件列表
- 测试用例的详细说明
- 测试覆盖的场景
- 测试运行结果（应该是红灯/失败）

### ✋ 确认点
**交互模式**：向用户展示测试用例，等待确认后继续
**自动模式**：展示测试用例后自动继续

---

## ✅ 阶段 3：实现代码 ✋

- [ ] 确保当前代码已提交到 git（作为回滚点）
- [ ] 编写实现代码
- [ ] 运行测试，确保测试通过（绿灯）
- [ ] 如果测试失败，修复或回滚
- [ ] 添加详细的中文注释
- [ ] 实现完整的错误处理和日志记录
- [ ] 确保错误信息对用户友好
- [ ] 提交代码到 git

### 📋 阶段 3 输出
- 实现的代码文件列表
- 关键代码片段和说明
- 测试运行结果（应该是绿灯/通过）
- Git 提交记录
- 遇到的问题和解决方案

### ✋ 确认点
**交互模式**：向用户展示实现，等待确认后继续
**自动模式**：展示实现后自动继续

---

## ✅ 阶段 4：完成和验证 ✋

- [ ] 运行完整的测试套件
- [ ] 所有测试必须通过
- [ ] 代码审查（检查注释、错误处理、代码组织）
- [ ] **记录变更到 CHANGELOG.md**（必须）
  - [ ] 记录变更类型（新增功能、修复bug、重构等）
  - [ ] 记录变更内容描述
  - [ ] 记录影响范围和相关文件
- [ ] **更新或创建功能文档**（必须）
  - [ ] 新功能：在 `docs/features/` 创建功能文档
  - [ ] 修改功能：更新对应的功能文档
  - [ ] 确保需求文档（README.md）保持为唯一的总体需求说明
- [ ] **Git 提交**（必须包含）
  - [ ] 代码变更
  - [ ] 相关测试
  - [ ] 文档更新
  - [ ] CHANGELOG.md 更新

### 📋 阶段 4 输出
- 完整的测试报告（所有测试通过）
- 代码审查结果
- **CHANGELOG.md 更新内容**
- **文档更新列表**（新增或修改的功能文档）
- 最终的 Git 提交记录
- 功能演示或使用说明
- 完成的任务清单总结

### ✋ 确认点
**交互模式**：向用户展示最终结果，等待确认
**自动模式**：展示最终结果，任务自动完成

---

## 详细说明

### 开始前的准备

1. **理解需求**
   - 仔细阅读用户的需求描述
   - 识别关键功能点
   - 明确成功标准
   - 识别潜在的边界情况

2. **头脑风暴和方案设计**
   - 考虑多种实现方案
   - 评估每种方案的优缺点
   - 选择最合适的技术栈
   - 考虑性能、可维护性、可扩展性

3. **任务拆分**
   - 将大任务拆分成小任务
   - 每个任务应该是独立的、可测试的
   - 任务粒度要足够细，方便 debug 和回滚
   - 使用 TodoWrite 工具记录所有任务

4. **确认方案**
   - 向用户展示技术方案
   - 说明实现步骤
   - 等待用户确认后再开始实施

### 实现过程中

1. **Git 准备**
   - 确保当前代码已提交
   - 创建功能分支（如果需要）
   - 确保有清晰的回滚点

2. **测试驱动开发（TDD）**
   - **红灯**：先写测试，运行测试，确保失败
   - **绿灯**：写最少的代码让测试通过
   - **重构**：优化代码，保持测试通过

3. **编写代码**
   - 遵循注释规范（中文、详细）
   - 实现完整的错误处理
   - 添加日志记录
   - 确保错误信息用户友好

4. **持续验证**
   - 每次修改后立即运行测试
   - 测试失败时分析原因
   - 无法快速修复时使用 git 回滚
   - 小步迭代，频繁提交

### 完成后的验证

1. **完整测试**
   - 运行所有测试用例
   - 确保 100% 通过
   - 检查测试覆盖率

2. **代码审查**
   - 检查注释是否完整
   - 检查错误处理是否完善
   - 检查代码组织是否清晰
   - 检查是否遵循编码规范

3. **文档更新**
   - 更新 README（如果需要）
   - 更新 API 文档（如果需要）
   - 添加使用示例（如果需要）

4. **变更记录（必须）**
   - **更新 CHANGELOG.md**
     - 记录变更日期和版本
     - 记录变更类型（Added/Changed/Fixed/Removed）
     - 详细描述变更内容
     - 列出影响的文件和模块

   - **文档组织规范**
     - **需求文档**：只维护一份 `README.md`
       - 包含项目整体需求、目标、架构
       - 不包含具体功能的详细实现
     - **功能文档**：每个功能模块独立文档
       - 位置：`docs/features/功能名称.md`
       - 内容：功能详细说明、API、使用示例
     - **变更日志**：`CHANGELOG.md`
       - 按时间倒序记录所有变更

5. **最终提交（必须包含）**
   - 编写清晰的 commit message（使用约定式提交格式）
   - 每次提交必须包含：
     - 代码变更
     - 相关测试
     - 文档更新（功能文档）
     - CHANGELOG.md 更新
   - 推送到远程仓库
   - 创建 Pull Request（如果需要）

## 快速检查表

### 每次提交前

```
□ 测试通过了吗？
□ 注释完整吗？
□ 错误处理完善吗？
□ CHANGELOG.md 更新了吗？
□ 功能文档更新或创建了吗？
□ Commit message 清晰吗？
□ 提交包含：代码 + 测试 + 文档 + CHANGELOG？
```

### 每个功能完成后

```
□ 所有测试都通过了吗？
□ 代码审查完成了吗？
□ CHANGELOG.md 记录了变更吗？
□ 功能文档已创建或更新吗？
□ 文档组织符合规范吗（一份需求文档 + 多份功能文档）？
□ Git 提交包含所有必要内容吗？
□ 可以部署了吗？
```

## 常见错误和解决方案

### 错误 1：测试失败但继续开发

**问题**：测试失败时没有停下来修复，而是继续开发新功能。

**解决**：
- 立即停止开发
- 分析测试失败原因
- 修复问题或回滚代码
- 确保测试通过后再继续

### 错误 2：注释不完整

**问题**：代码写完了但注释很少或没有注释。

**解决**：
- 在写代码的同时写注释
- 每个类、方法都要有文档注释
- 复杂逻辑要有行内注释
- 使用中文注释

### 错误 3：错误处理不完善

**问题**：只实现了正常流程，没有考虑异常情况。

**解决**：
- 识别所有可能的错误场景
- 为每个错误场景添加处理逻辑
- 记录错误日志
- 向用户展示友好的错误信息

### 错误 4：任务拆分不够细

**问题**：任务太大，难以跟踪进度，出错时难以定位。

**解决**：
- 将大任务拆分成更小的子任务
- 每个子任务应该在 1-2 小时内完成
- 使用 TodoWrite 跟踪每个子任务
- 每完成一个子任务就标记为完成

### 错误 5：没有频繁提交

**问题**：写了很多代码才提交一次，出错时难以回滚。

**解决**：
- 每完成一个小功能就提交
- 提交粒度要小
- 每次提交都应该是可工作的状态
- 使用清晰的 commit message

## 示例工作流程

### 场景：实现用户注册功能

#### 1. 开始前

```
✓ 理解需求：用户注册需要用户名、邮箱、密码
✓ 头脑风暴：使用 bcrypt 加密密码，验证邮箱格式
✓ 任务拆分：
  1. 创建测试文件
  2. 编写输入验证测试
  3. 实现输入验证
  4. 编写密码加密测试
  5. 实现密码加密
  6. 编写数据库保存测试
  7. 实现数据库保存
  8. 编写错误处理测试
  9. 实现错误处理
  10. 代码审查和提交
✓ 向用户确认方案
```

#### 2. 实现中

```
✓ Git 提交当前代码
✓ 创建 tests/test_user_service.py
✓ 编写输入验证测试
✓ 运行测试 → 失败（红灯）✓
✓ 实现输入验证逻辑
✓ 运行测试 → 通过（绿灯）✓
✓ 添加中文注释
✓ Git 提交："test: 添加用户注册输入验证测试"
✓ Git 提交："feat: 实现用户注册输入验证"

[继续下一个任务...]
```

#### 3. 完成后

```
✓ 运行所有测试 → 全部通过
✓ 代码审查 → 注释完整、错误处理完善
✓ 更新 README
✓ 最终提交："feat: 完成用户注册功能"
```
